<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PirateFlix ‚Äî Watch Anything</title>
    <meta name="description" content="PirateFlix ‚Äî Unlimited movies, TV shows and more. Stream what you love." />
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/landing.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
</head>

<body class="landing-page">

    <!-- ============ SIDEBAR ============ -->
    <nav class="sidebar" aria-label="Main Navigation">
        <div class="sidebar-logo">PirateFlix</div>

        <div class="sidebar-icon" title="Search" id="sb-search">
            <i data-feather="search"></i>
        </div>
        <div class="sidebar-icon active" title="Home" id="sb-home">
            <i data-feather="home"></i>
        </div>
        <div class="sidebar-icon" title="Movies" id="sb-movies">
            <i data-feather="film"></i>
        </div>
        <div class="sidebar-icon" title="Series" id="sb-series">
            <i data-feather="monitor"></i>
        </div>
        <div class="sidebar-icon" title="Trending" id="sb-trending">
            <i data-feather="trending-up"></i>
        </div>

        <div class="sidebar-spacer"></div>

        <div class="sidebar-icon" title="Add to List" id="sb-add">
            <i data-feather="plus"></i>
        </div>
        <div class="sidebar-icon" title="Shuffle" id="sb-shuffle">
            <i data-feather="shuffle"></i>
        </div>
    </nav>

    <!-- ============ MAIN CONTENT ============ -->
    <main class="main-content">

        <!-- === HERO SECTION === -->
        <section class="hero" id="heroSection">
            <div class="hero-backdrop" id="heroBg"></div>
            <div class="hero-overlay"></div>

            <!-- Top Nav -->
            <div class="top-nav">
                <div class="user-avatar" id="userAvatar">
                    <div class="avatar-circle" id="avatarInitial">P</div>
                    <span class="avatar-name" id="avatarName">Pirate</span>
                </div>
                <button class="btn-logout" id="logoutBtn">Sign out</button>
            </div>

            <!-- Hero Content -->
            <div class="hero-content" id="heroContent">
                <!-- Skeleton placeholders while loading -->
                <div
                    style="width:80px;height:20px;background:rgba(255,255,255,0.08);border-radius:6px;margin-bottom:12px;animation:shimmer 1.4s infinite;background-size:200% 100%;">
                </div>
                <div
                    style="width:60%;height:56px;background:rgba(255,255,255,0.08);border-radius:8px;margin-bottom:14px;animation:shimmer 1.4s infinite;background-size:200% 100%;">
                </div>
                <div
                    style="width:40%;height:16px;background:rgba(255,255,255,0.06);border-radius:4px;margin-bottom:24px;animation:shimmer 1.4s infinite;background-size:200% 100%;">
                </div>
                <div style="display:flex;gap:12px;">
                    <div
                        style="width:120px;height:44px;background:rgba(229,9,20,0.3);border-radius:50px;animation:shimmer 1.4s infinite;background-size:200% 100%;">
                    </div>
                    <div
                        style="width:140px;height:44px;background:rgba(255,255,255,0.06);border-radius:50px;animation:shimmer 1.4s infinite;background-size:200% 100%;">
                    </div>
                </div>
            </div>
        </section>

        <!-- === MOVIE ROWS === -->
        <section class="movies-section" id="moviesSection">
            <!-- Rows injected by JS -->
        </section>

    </main>

    <!-- === MODAL === -->
    <div class="modal-overlay" id="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal" id="modalBox">
            <button class="modal-close" id="modalClose" aria-label="Close"><i data-feather="x"></i></button>
            <img src="" alt="" class="modal-poster" id="modalPoster" />
            <div class="modal-title" id="modalTitle"></div>
            <div class="modal-meta" id="modalMeta"></div>
            <div class="modal-overview" id="modalOverview"></div>
        </div>
    </div>

    <!-- === TOAST === -->
    <div class="toast" id="toast" aria-live="polite"></div>

    <script src="js/config.js"></script>
    <script src="js/tmdb.js"></script>
    <script>
        // ============================================================
        //  PIRATEFLIX ‚Äî LANDING PAGE LOGIC
        // ============================================================

        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        /* ---- Auth Guard ---- */
        (async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            // Set user info
            const stored = sessionStorage.getItem('pf_user');
            const user = stored ? JSON.parse(stored) : null;
            const name = user?.username || session.user.email.split('@')[0];
            document.getElementById('avatarName').textContent = name;
            document.getElementById('avatarInitial').textContent = name.charAt(0).toUpperCase();

            // Init icons
            feather.replace();

            // Load content
            loadAll();
        })();

        /* ---- Logout ---- */
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await _supabase.auth.signOut();
            sessionStorage.removeItem('pf_user');
            window.location.href = 'login.html';
        });

        /* ---- Toast ---- */
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        /* ---- Sidebar navigation ---- */
        document.querySelectorAll('.sidebar-icon').forEach(icon => {
            icon.addEventListener('click', function () {
                document.querySelectorAll('.sidebar-icon').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            });
        });
        document.getElementById('sb-movies').addEventListener('click', () => window.location.href = 'movies.html');
        document.getElementById('sb-series').addEventListener('click', () => window.location.href = 'tvshows.html');

        /* ---- Hero ---- */
        let heroItems = [];
        let heroIdx = 0;

        function renderHero(item) {
            const backdrop = item.backdrop_path ? TMDB.backdrop(item.backdrop_path) : '';
            const title = item.title || item.name || 'Unknown';
            const rating = item.vote_average ? item.vote_average.toFixed(1) : 'N/A';
            const year = (item.release_date || item.first_air_date || '').slice(0, 4);
            const overview = item.overview || '';
            const type = item.media_type === 'tv' ? 'Series' : 'Movie';

            document.getElementById('heroBg').style.backgroundImage = backdrop ? `url('${backdrop}')` : '';

            document.getElementById('heroContent').innerHTML = `
      <div class="hero-badge">${type}</div>
      <h2 class="hero-title">${title}</h2>
      <div class="hero-meta">
        <div class="imdb-badge">IMDb ${rating}</div>
        <span class="hero-streams">üî• Trending</span>
        ${year ? `<span class="hero-year">${year}</span>` : ''}
      </div>
      <p class="hero-overview">${overview}</p>
      <div class="hero-buttons">
        <button class="btn-play" onclick="showToast('üè¥‚Äç‚ò†Ô∏è Arrr! Streaming not available in demo mode.')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
          Play
        </button>
        <button class="btn-trailer" onclick="openModal(${item.id}, '${item.media_type || 'movie'}')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8" fill="currentColor" stroke="none"/></svg>
          More Info
        </button>
      </div>
    `;
            feather.replace();
        }

        function cycleHero() {
            if (!heroItems.length) return;
            heroIdx = (heroIdx + 1) % Math.min(heroItems.length, 8);
            renderHero(heroItems[heroIdx]);
        }

        /* ---- Row Builder ---- */
        function buildRow(title, items, mediaType) {
            const section = document.getElementById('moviesSection');
            const rowId = 'row_' + Math.random().toString(36).slice(2, 8);

            const html = `
      <div class="movie-row">
        <div class="row-header">
          <h3 class="row-title">${title}</h3>
          <span class="row-see-all" onclick="showToast('Full browse coming soon!')">See all</span>
        </div>
        <div class="row-scroll-wrapper">
          <button class="row-arrow left"  onclick="scrollRow('${rowId}', -1)" aria-label="Scroll left">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
          </button>
          <div class="row-scroller" id="${rowId}">
            ${Array(10).fill(0).map(() => `<div class="skeleton"></div>`).join('')}
          </div>
          <button class="row-arrow right" onclick="scrollRow('${rowId}', 1)" aria-label="Scroll right">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"></polyline></svg>
          </button>
        </div>
      </div>
    `;
            section.insertAdjacentHTML('beforeend', html);

            // Fill with actual items
            if (items && items.length) {
                const scroller = document.getElementById(rowId);
                scroller.innerHTML = items.slice(0, 20).map(item => {
                    const mt = item.media_type || mediaType || 'movie';
                    const title = item.title || item.name || 'Unknown';
                    const poster = TMDB.poster(item.poster_path);
                    const rating = item.vote_average ? item.vote_average.toFixed(1) : '';
                    return `
          <div class="movie-card" onclick="openModal(${item.id}, '${mt}')" title="${title}">
            <img src="${poster}" alt="${title}" loading="lazy"
                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;160&quot; height=&quot;240&quot; viewBox=&quot;0 0 160 240&quot;%3E%3Crect width=&quot;160&quot; height=&quot;240&quot; fill=&quot;%23111&quot;/%3E%3Ctext x=&quot;50%25&quot; y=&quot;50%25&quot; text-anchor=&quot;middle&quot; fill=&quot;%23444&quot; font-size=&quot;12&quot; dy=&quot;.3em&quot;%3ENo Image%3C/text%3E%3C/svg%3E'"/>
            <div class="card-type-badge">${mt === 'tv' ? 'Series' : 'Movie'}</div>
            <div class="card-overlay">
              <div class="card-title">${title}</div>
              ${rating ? `<div class="card-rating">‚≠ê ${rating}</div>` : ''}
            </div>
          </div>
        `;
                }).join('');
            }

            return rowId;
        }

        /* ---- Scroll helper ---- */
        function scrollRow(rowId, direction) {
            const el = document.getElementById(rowId);
            if (el) el.scrollBy({ left: direction * 500, behavior: 'smooth' });
        }

        /* ---- Modal ---- */
        async function openModal(id, mediaType) {
            const overlay = document.getElementById('modalOverlay');
            overlay.classList.add('open');
            document.getElementById('modalTitle').textContent = 'Loading‚Ä¶';
            document.getElementById('modalMeta').textContent = '';
            document.getElementById('modalOverview').textContent = '';
            document.getElementById('modalPoster').src = '';

            try {
                const data = mediaType === 'tv'
                    ? await TMDB.tvDetails(id)
                    : await TMDB.movieDetails(id);

                const title = data.title || data.name || 'Unknown';
                const rating = data.vote_average ? data.vote_average.toFixed(1) : 'N/A';
                const year = (data.release_date || data.first_air_date || '').slice(0, 4);
                const runtime = data.runtime ? `${data.runtime} min` : (data.episode_run_time?.[0] ? `${data.episode_run_time[0]} min/ep` : '');
                const genres = (data.genres || []).slice(0, 3).map(g => g.name).join(' ¬∑ ');

                document.getElementById('modalPoster').src = TMDB.backdrop(data.backdrop_path, 'w780') || TMDB.poster(data.poster_path, 'w500');
                document.getElementById('modalPoster').alt = title;
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMeta').textContent = [year, runtime, genres, `‚≠ê ${rating}`].filter(Boolean).join(' ¬∑ ');
                document.getElementById('modalOverview').textContent = data.overview || 'No description available.';
            } catch (err) {
                document.getElementById('modalTitle').textContent = 'Failed to load details.';
            }
            feather.replace();
        }

        document.getElementById('modalClose').addEventListener('click', () => {
            document.getElementById('modalOverlay').classList.remove('open');
        });
        document.getElementById('modalOverlay').addEventListener('click', function (e) {
            if (e.target === this) this.classList.remove('open');
        });

        /* ---- Load everything ---- */
        async function loadAll() {
            try {
                const [trending, nowPlaying, topRated, popularTV, action, thriller] = await Promise.all([
                    TMDB.trending(),
                    TMDB.nowPlaying(),
                    TMDB.topRated(),
                    TMDB.popularTV(),
                    TMDB.action(),
                    TMDB.thriller(),
                ]);

                // Hero
                heroItems = trending.results || [];
                if (heroItems.length) {
                    renderHero(heroItems[0]);
                    setInterval(cycleHero, 8000);
                }

                // Rows
                buildRow('üî• Trending This Week', trending.results, 'movie');
                buildRow('üé¨ New This Week', nowPlaying.results, 'movie');
                buildRow('üì∫ Popular TV Series', popularTV.results, 'tv');
                buildRow('‚≠ê Top Rated Movies', topRated.results, 'movie');
                buildRow('üí• Action & Adventure', action.results, 'movie');
                buildRow('üî™ Thrillers', thriller.results, 'movie');

            } catch (err) {
                console.error('Failed to load content:', err);
                showToast('‚ö†Ô∏è Could not load movies. Check your connection.');
            }
        }
    </script>
</body>

</html>